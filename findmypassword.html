<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="css/style2.css">
  <style type="text/css">
  .message {
  margin: 15px 0 0;
  color: #b3b3b3;
  font-size: 12px;
  text-align: center;
  }
  .message a {
  	color: #EF3B3A;
  	  text-decoration: none;
  }
  body{
    background: url('bk.jpg');
    background-size: cover;
  	background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }
  #kicon,#sendcode,#code{
    display: none;
  }
  .ps,#confirm{
    display: none;
  }
  </style>
</head>

<body> 

<div class="container-login">
   <div class="info">
    <h1 style='color:grey;text-align: center;'>Quick Chat</h1>
    <span style='color:grey;text-align:center;display: block;'>Made with <i class="fa fa-heart" ></i> by <a href=# style='color:grey'>Sheng Xiao</a></span>
  </div>
  <form>
    <div class="row">
      <h1 style="text-align: center;" id='title'>Find My Password</h1>
      <p id='hint'>Please enter you email to get a confirmation code:</p>
       <div class="input-group input-group-icon">
        <input type="email" placeholder="Email Adress" id='email'/>
        <div class="input-icon" id='eicon'><i class="fa fa-envelope"></i></div>
      </div>
      <div class="input-group input-group-icon">
        <input type="text" placeholder="Confirmation Code" id='code'/>
        <div class="input-icon" id='kicon'><i class="fa fa-key"></i></div>
      </div>

      <div class="input-group input-group-icon ps" >
        <input type="password" placeholder="New Password" id='paswordnew'/>
        <div class="input-icon"><i class="fa fa-key"></i></div>
      </div>
      <div class="input-group input-group-icon ps" >
        <input type="Password" placeholder="Confirm Password" id='passwordconfirm'/>
        <div class="input-icon"><i class="fa fa-key"></i></div>
        <p id='password_w' style="color: red;display: block;"><strong>Warning: </strong> Password does not match!</p>
      </div>
    </div>
    
    <div class="input-group">
          <input type="button" name="sendemail" value="Send" id='sendemail' class='nextbutton'/>
          <input type="button" name="sendcode" value="Send" id='sendcode' class='nextbutton'/>
          <input type="button" name="confirm" value="Confirm" id='confirm' class='nextbutton'/>
    </div>
        <p class="message">Not registered? <a href="register.html">Create an account</a></p>

  </form>
</div>
  <script type="text/javascript">
    var userid;
    var code;
    //email verification
    $('#sendemail').click(function(){
      var email=$('#email').val();
      $.ajax({
        url:"findmypassword.php",
        data:{'email':email},
        dataType:"text",
        success:function(data){
          
              var token=[];
              token=data.split(",,");
              userid=token[0];
              if($.isNumeric(userid)){
              alert(token[1]);
              $("#title").text("Enter Code");
              $("#hint").text("Please enter your confirmation code in 5 minutes");
              $("#email").hide();
              $("#code").show();
              $("#eicon").hide();
              $("#kicon").show();
              $("#sendemail").hide();
              $("#sendcode").show();
          }else{
            alert(data);
          }
        },
        type:'POST'
      });
    });
    // code verification
    $('#sendcode').click(function(){
      code=$('#code').val();
      if(code!=''){
        $.ajax({
        url:"findmypassword-code.php",
        data:{'userid':userid,'code':code},
        dataType:'text',
        success:function(data){
          //need to check if code correct && if code is used in less than 15 minus
          if(data==1/*need to control block in verify php*/){
            $('#code').hide();
            $('.ps').show();
            $('#sendcode').hide();
            $("#confirm").show();
            $('p').hide();
            $('#title').text('Enter New Password');
          }
          else if(data>300){
            alert('Verification code expired\nPlease get a new code');
          }
          else{
            alert(data);
          }
        },
        type:"POST"
      });
      }
      else{
        alert('Please enter your code');
      }
    });
    //update password to database
    $("#passwordconfirm").change(function(){
      var password_1=$('#paswordnew').val();
      var password_2=$('#passwordconfirm').val();
      if(password_1!=''&&password_1!=password_2){
        $("#password_w").show();
        $("#passwordconfirm").val("");
      }
      if(password_1!=''&&password_1==password_2){
        $("#password_w").hide();
      }
    });

    $("#passwordconfirm").click(function(){
      $("#password_w").hide();
    });

    $("#paswordnew").change(function(){
      var password_1=$('#paswordnew').val();
      var password_2=$('#passwordconfirm').val();
      if(password_2!=''&&password_1!=password_2){
        $("#password_w").show();
        $("#passwordconfirm").val("");
      }
      if(password_1!=''&&password_1==password_2){
        $("#password_w").hide();
      }
    });

    $("#passwordnew").click(function(){
      $("#password_w").hide();
    });

    $("#confirm").click(function(){
      var password_1=$('#paswordnew').val();
      var password_2=$('#passwordconfirm').val();
      if(password_1!=password_2){
          $("#password_w").show();
      }
      else if(password_1.length<6){
          $("#password_w").html('<strong>Warning: </strong>Password character should more than 5');
          $("#password_w").show();
      }
      else{
        //updata database
        $.ajax({
          url:'findmypassword-newpassword.php',
          data:{'userid':userid,'password':password_1},
          dataType:'text',
          success:function(data){
            alert(data);
            $(location).attr('href','index.php');
          },
          type:'POST'
        });
      }
    });
  </script>
</body>
</html>
